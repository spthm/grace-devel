# DO NOT EDIT THIS FILE.
# Instead, copy Makefile.config.example to Makefile.config, and modify that.

# This file may be included from multiple locations, but this file may also
# specify locations relative to itself.
THIS_PATH = $(dir $(lastword $(MAKEFILE_LIST)))

# E.g. make's 'include' is NOT relative to the current file, it is relative to
# the Makefile with which make was called.
include $(THIS_PATH)Makefile.config

# abspath does not require files to exist.
# We must use absolute paths because these dependencies will be used by
# Makefiles in multiple locations.
GRACE_DIR := $(abspath $(THIS_PATH)/../)
GRACE_INC_DIR := $(abspath $(GRACE_DIR)/include/)

# This is required only for segmented_scan.cu's printf formatting; it is not
# required by GRACE.
SGPU_DIR := $(abspath $(GRACE_DIR)/include/grace/external/sgpu/)

# We could do some of this on a Makefile-by-Makefile basis instead to save
# re-compiling everything when only a few headers are changed, but that is
# extremely error prone.
DEPS = Makefile
DEPS += $(abspath $(THIS_PATH)Makefile.common)
DEPS += $(abspath $(THIS_PATH)Makefile.config)

DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/*.hpp))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/*.h))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/detail/*.hpp))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/detail/*.h))

DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/generic/*.h))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/generic/*.hpp))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/generic/detail/*.h))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/generic/detail/*.hpp))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/generic/functors/*.h))
DEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/generic/functors/*.hpp))

DEPS += $(abspath $(wildcard $(THIS_PATH)/helper/*.h))
DEPS += $(abspath $(wildcard $(THIS_PATH)/helper/*.hpp))
DEPS += $(abspath $(wildcard $(THIS_PATH)/helper-unit/*.h))
DEPS += $(abspath $(wildcard $(THIS_PATH)/helper-unit/*.hpp))

NVCCDEPS = $(DEPS)
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/detail/*.cuh))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/detail/*.h))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/detail/*.hpp))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/detail/device/*.cuh))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/detail/functors/*.cuh))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/detail/kernels/*.cuh))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/util/*.cuh))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/*.cuh))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/*.h))
NVCCDEPS += $(abspath $(wildcard $(GRACE_INC_DIR)/grace/cuda/*.hpp))

NVCCDEPS += $(abspath $(wildcard $(THIS_PATH)/helper/*.cuh))

INCLUDES = -I$(GRACE_INC_DIR) -I$(GRACE_DIR)/tests/
NVCCINCLUDES = $(INCLUDES) -I$(SGPU_DIR)

CXXFLAGS = $(GRACE_FLAGS)
NVCCFLAGS = $(GRACE_FLAGS) $(CUARCH)

ifdef USE_OPENMP
ifeq ($(USE_OPENMP), 1)
CXXFLAGS += -fopenmp
NVCCFLAGS += -Xcompiler "-fopenmp"
endif
endif

# NB: Do NOT use -G. It is not compatible with Thrust.
ifdef GRACE_DEBUG
ifeq ($(GRACE_DEBUG), 1)
CXXFLAGS += -DGRACE_DEBUG -DTHRUST_DEBUG -g
NVCCFLAGS += -DGRACE_DEBUG -DTHRUST_DEBUG -g -lineinfo
endif
endif

NVCCLFLAGS += $(CUDA_LIB)

NVCCLIBS = -lcuda -lcurand
