# DO NOT EDIT THIS FILE.
# Instead, copy Makefile.config.example to Makefile.config, and modify that.

# This file may be included from multiple locations, but this file may specify
# locations relative to itself.
THIS_PATH = $(dir $(lastword $(MAKEFILE_LIST)))

# E.g. make's 'include' is NOT relative to the current file, it is relative to
# the Makefile with which make was called.
include $(THIS_PATH)Makefile.config

MGPU_OBJS = mgpucontext.o mgpuutil.o

# abspath does not require files to exist.
# We must use absolute paths because these dependencies will be used by
# Makefiles in multiple locations.
GRACE_DIR := $(abspath $(GRACE_DIR))
MGPU_OBJS := $(abspath $(addprefix $(THIS_PATH),$(MGPU_OBJS)))

# We could do this on a Makefile-by-Makefile basis instead to save re-compiling
# everything when only a few headers are changed, but that is extremely prone
# to error.
NVCCDEPS = Makefile
NVCCDEPS += $(abspath $(wildcard ../device/*.cuh))
NVCCDEPS += $(abspath $(wildcard ../kernels/*.cuh))
NVCCDEPS += $(abspath $(wildcard ../util/*.cuh))
NVCCDEPS += $(abspath $(wildcard ../util/*.h))
NVCCDEPS += $(abspath $(wildcard ../*.cuh))
NVCCDEPS += $(abspath $(wildcard ../*.h))
NVCCDEPS += $(MGPU_OBJS)

NVCCINCLUDES = -I$(GRACE_DIR) -I$(MGPU_DIR)/include/

NVCCFLAGS = $(CUARCH) $(GRACE_FLAGS)

NVCCLFLAGS = -L$(CUDA_DIR)

NVCCLIBS = $(MGPU_OBJS) -lcuda -lcurand

# TODO: These rules are too fragile! E.g. if MGPU_OBJS has its order switched.
$(firstword $(MGPU_OBJS)): $(MGPU_DIR)/src/mgpucontext.cu
	$(NVCC) $(NVCCFLAGS) $(NVCCINCLUDES) -o $@ -c $<

$(lastword $(MGPU_OBJS)): $(MGPU_DIR)/src/mgpuutil.cpp
	$(NVCC) $(NVCCFLAGS) $(NVCCINCLUDES) -o $@ -c $<
